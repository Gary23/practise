<html>

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<style type="text/css">
		body,
		html,
		#allmap {
			width: 100%;
			height: 100%;
			overflow: hidden;
			margin: 0;
			font-family: "微软雅黑";
		}
	</style>
	<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=OZGI8qUv7izIC4ph8Hn79IVQ"></script>
	<title>百度地图</title>
	<style>
		.container {
			background-color: #fff;
			height: 100%;
			background-color: #fafafa;
		}

		.container.isPhone {
			padding-top: 0;
		}

		#r-result {
			color: #777;
			background-color: #fff;
			height: 0.96rem;
			line-height: 0.64rem;
			overflow: hidden;
			font: 0.32rem Arial;
			padding: 0.16rem 0.32rem;
			border-top: 1px solid #cccccc;
		}

		#suggestId {
			color: #777;
			border-radius: 0.128rem 0 0 0.128rem;
			background-color: #f6f6f6;
			display: inline-block;
			outline: 0 none;
			width: 80%;
			height: 2em;
			line-height: 2em;
			float: left;
			display: block;
			border: none;
		}

		#but {
			float: left;
			display: block;
			width: 20%;
			height: 0.64rem;
			border-radius: 0 0.128rem 0.128rem 0;
			background: #111;
			color: #fff;
			line-height: 0.64rem;
			text-align: center;
			cursor: pointer;
		}

		#result {
			width: 100%;
			height: 100%;
		}

		.BMap_scaleCtrl {
			top: auto !important;
			left: 0.32rem !important;
			bottom: 0.96rem !important;
		}

		.BMap_stdMpCtrl {
			bottom: 0.64rem !important;
		}

		#list {
			border-top: 1px solid #eeeeee;
			display: block;
			font-size: 12px;
			height: 40%;
			overflow: auto;
		}

		#list li a {
			display: block;
			width: 100%;
			height: 100%;
			padding: 0.128rem 0.32rem;
			background-color: #fafafa;
			border-bottom: 1px solid #dddddd;
			line-height: 0.448rem;
		}

		#allmap {
			height: 50%;
		}

		#step {
			position: absolute;
			color: #ffffff;
			padding: 0.32rem;
			background-color: rgba(0,0,0,0.7);
			border-radius: 5px;
			width: 90%;
			top: 2.2208rem;
			left: 0.32rem;
		}

		#step .jt {
			position: absolute;
			top: -40px;
			left: 40px;
			font-size: 0;
			height: 0;
			border: 20px solid rgba(0,0,0,0);
		}
		#step p {
			text-align: center;
		}
		#step .over {
			border: 1px solid #ffffff;
			color: #fff;
			padding: 0 8px;
			display: inline-block;
			font-size: 0.32rem;
			margin-top: 10px;
			border-radius: 5px;
		}
		#step .jt_top {
			border-bottom:20px solid rgba(0, 0, 0, 0.7)
		}


	</style>
</head>

<body>
	<{if !$app_status}>
		<header class="page-header">
			<i class="header-left icon-func bbc-icon bbc-icon-back shopex-action-back"></i>
			<div class="header-title">选择地址</div>
		</header>
		<{/if}>
			<{if !$app_status}>
				<section class="container">
					<{else}>
						<section class="container isPhone">
							<{/if}>
								<div id="r-result">
									<input type="text" id="suggestId" size="20" value="" placeholder="点击查找小区/大厦" onchange="this.blur();" />
									<buttton id="but">搜索</buttton>
									<input type="hidden" value="" id="data-floor">
								</div>

								<div id="searchResultPanel" style="border:1px solid #C0C0C0;width:120px;height:auto; display:none;"></div>


								<div id="allmap"></div>
								<div id="list">
									<ul id="pois">
									</ul>
								</div>

								<div id="result"></div>

								<div id="step">
									<b class="jt jt_top"></b>
									<p>可直接搜索您所在的小区/大厦</p>
									<p>
										<a href="javascript:;" class="over">确定</a>
									</p>
								</div>

						</section>


</body>

</html>
<script type="text/javascript">
	function baiduMAP(Coord, zoom, gps) {
		// 初始化参数
		this.Coord = Coord || { lng: "120.388969", lat: "36.073179" };
		this.zoom = zoom || 12;
		this.gps = gps || false;
		//创建地图
		this.map = new BMap.Map("allmap", { enableMapClick: false });
		this.marker = '';
		this.myValue = '';
		// 初始化编码实例
		this.myGeo = new BMap.Geocoder();

		// 初始化坐标转换
		this.convertor = new BMap.Convertor();



		// 初始化一个自动完成关联搜索的对象
		this.ac = new BMap.Autocomplete(
			{
				"input": "suggestId",
				"location": this.map
			});

		this.init();

	}

	baiduMAP.prototype = {
		constructor: baiduMAP,
		init: function () {		// 三种情况初始化地图
			var typeCoors = typeof this.Coord;
			var _this = this;
			if (typeCoors.toLowerCase() == 'string') {        // 通过地区名初始化地图
				this.myGeo.getPoint(this.Coord, function (point) {      // 解析地区名为坐标，解析不到就默认青岛
					point = point || { lng: "120.388969", lat: "36.073179" };
					if (point) {
						// 初始化地图
						var point = new BMap.Point(point.lng, point.lat);
						_this.map.centerAndZoom(point, _this.zoom);
						_this.marker = new BMap.Marker(point);
						_this.map.addOverlay(_this.marker);
						_this.myGeo.getLocation(new BMap.Point(point.lng, point.lat), function (result) {
							_this.getLocationList.call(_this, result);
						});
					}
				});
			} else
				if (this.gps) {    // gps坐标转为百度地图坐标,并初始化地图
					// 初始化地图
					var point = new BMap.Point(this.Coord.lng, this.Coord.lat);
					this.map.centerAndZoom(point, this.zoom);
					this.marker = new BMap.Marker(point);
					var pointArr = [point];
					this.convertor.translate(pointArr, 1, 5, function (data) {
						_this.translateCallback.call(_this, data);
					})
				} else {      // 通过坐标直接初始化地图
					var point = new BMap.Point(this.Coord.lng, this.Coord.lat);
					this.map.centerAndZoom(point, this.zoom);
					this.marker = new BMap.Marker(point);
					this.map.addOverlay(this.marker);
					this.myGeo.getLocation(new BMap.Point(this.Coord.lng, this.Coord.lat), function (result) {
						_this.getLocationList.call(_this, result);
					});
				}
			// 添加地图控件
			this.control();

			//点击地图到另外的位置
			this.map.addEventListener("click", function (e) {
				_this.clickMap(e, _this);
			});

			//鼠标放在下拉列表上的事件
			this.ac.addEventListener("onhighlight", function (e) {
				_this.mouseList(e);
			})

			//鼠标点击下拉列表后的事件
			this.ac.addEventListener("onconfirm", function (e) {
				_this.clickList(e);
			})

			// 点击搜索按钮事件
			this.G('but').onclick = function () {
				_this.searchMap();
			}
		},
		clickMap: function (e, _this) {	//点击地图到另外的位置
			if($('#step')){
				$('#step').hide();
			}
			var point = {
				lng: e.point.lng,
				lat: e.point.lat
			}
			this.map.clearOverlays();    //清除地图上所有覆盖物
			this.map.panTo(new BMap.Point(point.lng, point.lat));  //平移到新的坐标点
			var pt = new BMap.Point(point.lng, point.lat);  // 创建点坐标
			var marker = new BMap.Marker(pt);        // 创建标注
			this.map.addOverlay(marker);               // 将标注添加到地图中
			// 在有覆盖物的前提下设置为覆盖物的坐标
			if (e.overlay != null) {
				var p = e.overlay.getPosition();
				pt.lng = p.lng;
				pt.lat = p.lat;
			}
			// 根据坐标得到地址描述
			this.myGeo.getLocation(new BMap.Point(point.lng, point.lat), function (result) {
				_this.getLocationList.call(_this, result);
			});
		},
		control: function () {
			var top_left_navigation = new BMap.NavigationControl();  //左上角，添加默认缩放平移控件
			this.map.addControl(top_left_navigation);
		},
		translateCallback: function (data) {		//坐标转换完之后的回调函数
			if (data.status === 0) {
				this.map.clearOverlays();    //清除地图上所有覆盖物
				this.marker = new BMap.Marker(data.points[0]);
				this.map.addOverlay(this.marker);
				this.getLocationList(data.points[0].lng, data.points[0].lat);
			}
		},
		getLocationList: function (result) {		// 根据坐标得到地址并展示在列表中
			if (result) {
				var s = [];
				var l = [];
				if (result.surroundingPois.length > 0) {
					var pois = result.surroundingPois;
					for (var i = 0; i < pois.length; i++) {
						s.push(pois[i].title + ',' + pois[i].address);
						l.push(pois[i].point.lng + ',' + pois[i].point.lat);
					}
				} else {
					s = result.address;
					l = result.point.lng + ',' + result.point.lat;
				}
				this.setList(s, l);
			}
		},
		mouseList: function (e) {
			var str = "";
			var _value = e.fromitem.value;
			var value = "";
			if (e.fromitem.index > -1) {
				value = _value.province + _value.city + _value.district + _value.street + _value.business;
			}
			str = "FromItem<br />index = " + e.fromitem.index + "<br />value = " + value;

			value = "";
			if (e.toitem.index > -1) {
				_value = e.toitem.value;
				value = _value.province + _value.city + _value.district + _value.street + _value.business;
			}
			str += "<br />ToItem<br />index = " + e.toitem.index + "<br />value = " + value;
			this.G("searchResultPanel").innerHTML = str;
		},
		clickList: function (e) {
			var _value = e.item.value;
			this.myValue = _value.province + _value.city + _value.district + _value.street + _value.business;
			this.G("searchResultPanel").innerHTML = "onconfirm<br />index = " + e.item.index + "<br />myValue = " + this.myValue;
			this.G("suggestId").blur();
			this.setPlace(this);
		},
		setPlace: function (_this) {
			this.map.clearOverlays();    //清除地图上所有覆盖物
			var local = new BMap.LocalSearch(this.map, { //智能搜索
				onSearchComplete: function (results) {
					_this.myFun.call(_this, results);
				}
			});

			local.search(this.myValue);
		},
		searchMap: function () {
			var _this = this;
			this.map.clearOverlays();    //清除地图上所有覆盖物
			var search = this.G('suggestId').value;
			if (!search) return false;
			var local = new BMap.LocalSearch(this.map, {
				onSearchComplete: function (results) {
					_this.myFun.call(_this, results)
				}
			});
			local.search(search);
		},
		myFun: function (results) {		// 将搜索的信息在地图上创建标注，一般是多个标注3
			if (results) {
				// 判断状态是否正确
				var s = [];
				var lnglat = [];
				for (var i = 0; i < results.getCurrentNumPois(); i++) {
					var pt = new BMap.Point(results.getPoi(i).point.lng, results.getPoi(i).point.lat);  // 创建点坐标
					this.map.centerAndZoom(pt, 12);
					var marker = new BMap.Marker(pt);        // 创建标注
					this.map.addOverlay(marker);               // 将标注添加到地图中
					s.push(results.getPoi(i).title + ", " + results.getPoi(i).address);
					lnglat.push(results.getPoi(i).point.lng + ',' + results.getPoi(i).point.lat);
				}
				this.setList(s, lnglat);
			}
		},
		setList: function (s, l) {
			var arr, title, text, str = '';
			var url = "javascript:;";
			var pois = this.G('pois')

			// 创建html内容
			if ((typeof s).toLowerCase() == 'string') {
				str = '<li><a href=' + url + ' onclick="urlBack(this)";><p class="addr-text">' + s + '</p><input type="hidden" value=' + l + '></a></li>';
			} else {
				for (var i = 0; i < s.length; i++) {
					arr = s[i].split(',');
					title = arr[0];
					text = arr[1];
					str += '<li><a href=' + url + ' onclick="urlBack(this);"><p class="addr-title">' + title + '</p><p class="addr-text">' + text + '</p><input type="hidden" value=' + l[i] + '></a></li>';
				}
			}
			pois.innerHTML = str;
		},
		G: function (id) {
			return document.getElementById(id);
		}

	}

	// 将地理信息存储
	function urlBack(elem) {
		// 获取地理位置
		if (elem.querySelector('.addr-title')) {
			var addr_title = elem.querySelector('.addr-title').innerHTML;
		}
		var addr_text = elem.querySelector('.addr-text').innerHTML;

		var lnglat = elem.querySelector('.addr-text').nextSibling.value;

		var addr_obj = {
			text: addr_text,
			lnglat: lnglat
		}

		if (addr_title) {
			addr_obj.title = addr_title;
		}
		// window.localStorage.setItem('re','1')
		// 将地理位置存储
		window.localStorage.setItem('addr', JSON.stringify(addr_obj))

		window.history.back();

	}


	
	$(function () {
		$('.over,.container').on('tap click',function(){
			$('#step').hide();
		})

		// -------------------------地图调用-------------------------------
		var Coord = '';
		var Current = '';
		// h5获取地理位置参数
		var options = {
			enableHighAcuracy: true,
			timeout: 2000
		}

		var areaObj = JSON.parse(window.localStorage.getItem('area'));


		if (areaObj.city) {       // 通过地区创建地图
			Coord = areaObj.city;
			new baiduMAP(Coord, 12);
		} else
			if (areaObj.lng && areaObj.lat) {     // 通过坐标创建地图
				Current = { lng: areaObj.lng, lat: areaObj.lat };
				new baiduMAP(Current, 12);
			}
			else {           // 通过h5获取的地理位置创建地图
				// 获取当前地理位置
				navigator.geolocation.getCurrentPosition(successMap, errorMap, options);

				function successMap(position) {
					if (position) {
						var latitude = position.coords.latitude;
						var longitude = position.coords.longitude;
						Current = { lng: longitude, lat: latitude };
					} else {
						Current = { lng: "120.388969", lat: "36.073179" };
					}
					new baiduMAP(Current, 13, true);
				}

				function errorMap(err) {
					Current = { lng: "120.388969", lat: "36.073179" };
					new baiduMAP(Current, 12);
				}
			}
	})

</script>